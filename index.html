<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Statistics</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
            line-height: 1.6;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            padding: 24px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.08);
        }

        h1 {
            margin-bottom: 20px;
            color: #333;
            font-size: 24px;
        }

        .form-group {
            margin-bottom: 16px;
        }

        label {
            display: block;
            margin-bottom: 4px;
            color: #555;
            font-size: 14px;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }

        button {
            background: #4CAF50;
            color: white;
            padding: 10px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 15px;
            width: 100%;
            margin-top: 8px;
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .results {
            margin-top: 20px;
            padding: 16px;
            background: #fafafa;
            border-radius: 4px;
            display: none;
        }

        .results.show {
            display: block;
        }

        .stat-row {
            display: flex;
            justify-content: space-between;
            padding: 6px 0;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }

        .stat-row:last-child {
            border-bottom: none;
        }

        .stat-label {
            color: #666;
        }

        .stat-value {
            color: #222;
            font-weight: 500;
        }

        .error {
            margin-top: 12px;
            padding: 10px;
            border-radius: 4px;
            background: #ffebee;
            color: #c62828;
            font-size: 14px;
            display: none;
        }

        .error.show {
            display: block;
        }

        .badge {
            display: inline-block;
            margin-left: 8px;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 11px;
        }

        .badge.cache {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .badge.fresh {
            background: #fff3e0;
            color: #e65100;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Stock Statistics</h1>

        <form id="statsForm">
            <div class="form-group">
                <label for="ticker">Ticker</label>
                <input id="ticker" type="text" placeholder="MSFT, AAPL" required>
            </div>

            <div class="form-group">
                <label for="start">Start date</label>
                <input id="start" type="date" required>
            </div>

            <div class="form-group">
                <label for="end">End date</label>
                <input id="end" type="date" required>
            </div>

            <div class="form-group">
                <label for="source">Source</label>
                <select id="source">
                    <option value="live">Live (yfinance)</option>
                    <option value="msft">MSFT sample</option>
                    <option value="aapl">AAPL sample</option>
                    <option value="amzn">AMZN sample</option>
                    <option value="googl">GOOGL sample</option>
                    <option value="tsla">TSLA sample</option>
                </select>
            </div>

            <button id="submit" type="submit">Get stats</button>
        </form>

        <div id="error" class="error"></div>

        <div id="results" class="results">
            <div id="content"></div>
        </div>

        <hr style="margin: 24px 0;">

        <form id="batchForm">
            <h2 style="font-size: 18px; margin-bottom: 12px;">Batch stats</h2>
            <div class="form-group">
                <label for="batchTickers">Tickers (comma separated)</label>
                <input id="batchTickers" type="text" placeholder="AAPL,MSFT,GOOGL">
            </div>
            <div class="form-group">
                <label for="batchStart">Start date</label>
                <input id="batchStart" type="date">
            </div>
            <div class="form-group">
                <label for="batchEnd">End date</label>
                <input id="batchEnd" type="date">
            </div>
            <button id="batchSubmit" type="submit">Get batch stats</button>
        </form>

        <div id="batchResults" class="results">
            <div id="batchContent"></div>
        </div>

        <hr style="margin: 24px 0;">

        <form id="compareForm">
            <h2 style="font-size: 18px; margin-bottom: 12px;">Compare stocks</h2>
            <div class="form-group">
                <label for="compareTickers">Tickers (comma separated)</label>
                <input id="compareTickers" type="text" placeholder="AAPL,MSFT,GOOGL">
            </div>
            <div class="form-group">
                <label for="compareStart">Start date</label>
                <input id="compareStart" type="date">
            </div>
            <div class="form-group">
                <label for="compareEnd">End date</label>
                <input id="compareEnd" type="date">
            </div>
            <button id="compareSubmit" type="submit">Compare</button>
        </form>

        <div id="compareResults" class="results">
            <div id="compareContent"></div>
        </div>
    </div>

    <script>
        const form = document.getElementById('statsForm');
        const button = document.getElementById('submit');
        const results = document.getElementById('results');
        const content = document.getElementById('content');
        const errorBox = document.getElementById('error');

        const batchForm = document.getElementById('batchForm');
        const batchButton = document.getElementById('batchSubmit');
        const batchResults = document.getElementById('batchResults');
        const batchContent = document.getElementById('batchContent');

        const compareForm = document.getElementById('compareForm');
        const compareButton = document.getElementById('compareSubmit');
        const compareResults = document.getElementById('compareResults');
        const compareContent = document.getElementById('compareContent');

        const today = new Date();
        const monthAgo = new Date();
        monthAgo.setMonth(monthAgo.getMonth() - 1);

        document.getElementById('end').valueAsDate = today;
        document.getElementById('start').valueAsDate = monthAgo;
        document.getElementById('batchEnd').valueAsDate = today;
        document.getElementById('batchStart').valueAsDate = monthAgo;
        document.getElementById('compareEnd').valueAsDate = today;
        document.getElementById('compareStart').valueAsDate = monthAgo;

        form.addEventListener('submit', async (event) => {
            event.preventDefault();

            results.classList.remove('show');
            errorBox.classList.remove('show');

            const ticker = document.getElementById('ticker').value.trim().toUpperCase();
            const start = document.getElementById('start').value;
            const end = document.getElementById('end').value;
            const source = document.getElementById('source').value;

            if (!ticker) {
                errorBox.textContent = 'Please enter a ticker';
                errorBox.classList.add('show');
                return;
            }

            let url = `/api/stats?ticker=${encodeURIComponent(ticker)}&start=${start}&end=${end}`;

            if (source !== 'live') {
                const files = {
                    msft: 'data/msft_2024.csv',
                    aapl: 'data/aapl_2024.csv',
                    amzn: 'data/amzn_sample.csv',
                    googl: 'data/googl_sample.csv',
                    tsla: 'data/tsla_sample.csv',
                };
                url += `&sample_file=${encodeURIComponent(files[source])}`;
            }

            button.disabled = true;
            button.textContent = 'Loading...';

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Request failed');
                }

                const badge = data.cache_hit
                    ? '<span class="badge cache">cache</span>'
                    : '<span class="badge fresh">fresh</span>';

                content.innerHTML = `
                    <div class="stat-row">
                        <span class="stat-label">Symbol</span>
                        <span class="stat-value">${data.symbol}${badge}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Period</span>
                        <span class="stat-value">${data.period.start} â†’ ${data.period.end}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">High</span>
                        <span class="stat-value">$${data.high.toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Low</span>
                        <span class="stat-value">$${data.low.toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Average close</span>
                        <span class="stat-value">$${data.average_close.toFixed(2)}</span>
                    </div>
                    <div class="stat-row">
                        <span class="stat-label">Last close</span>
                        <span class="stat-value">$${data.last_close.toFixed(2)}</span>
                    </div>
                `;

                results.classList.add('show');
            } catch (err) {
                errorBox.textContent = err.message || 'Something went wrong';
                errorBox.classList.add('show');
            } finally {
                button.disabled = false;
                button.textContent = 'Get stats';
            }
        });

        batchForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            batchResults.classList.remove('show');
            errorBox.classList.remove('show');

            const rawTickers = document.getElementById('batchTickers').value;
            const start = document.getElementById('batchStart').value;
            const end = document.getElementById('batchEnd').value;

            const tickers = rawTickers
                .split(',')
                .map(t => t.trim().toUpperCase())
                .filter(t => t.length > 0);

            if (tickers.length === 0) {
                errorBox.textContent = 'Please enter at least one ticker';
                errorBox.classList.add('show');
                return;
            }

            batchButton.disabled = true;
            batchButton.textContent = 'Loading...';

            try {
                const response = await fetch('/api/stats/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ tickers, start, end })
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Request failed');
                }

                const items = data.items || {};
                const html = Object.keys(items).map(symbol => {
                    const s = items[symbol];
                    if (!s || s.high == null || s.low == null || s.average_close == null) {
                        return '';
                    }
                    return `
                        <div class="stat-row">
                            <span class="stat-label">${symbol}</span>
                            <span class="stat-value">
                                High $${s.high.toFixed(2)},
                                Low $${s.low.toFixed(2)},
                                Avg $${s.average_close.toFixed(2)}
                            </span>
                        </div>
                    `;
                }).join('');

                batchContent.innerHTML = html || '<p>No data</p>';
                batchResults.classList.add('show');
            } catch (err) {
                errorBox.textContent = err.message || 'Something went wrong';
                errorBox.classList.add('show');
            } finally {
                batchButton.disabled = false;
                batchButton.textContent = 'Get batch stats';
            }
        });

        compareForm.addEventListener('submit', async (event) => {
            event.preventDefault();

            compareResults.classList.remove('show');
            errorBox.classList.remove('show');

            const tickers = document.getElementById('compareTickers').value.trim();
            const start = document.getElementById('compareStart').value;
            const end = document.getElementById('compareEnd').value;

            if (!tickers) {
                errorBox.textContent = 'Please enter at least one ticker';
                errorBox.classList.add('show');
                return;
            }

            compareButton.disabled = true;
            compareButton.textContent = 'Loading...';

            const url = `/api/compare?tickers=${encodeURIComponent(tickers)}&start=${start}&end=${end}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.detail || 'Request failed');
                }

                const items = data.items || [];
                const html = items.map(item => `
                    <div class="stat-row">
                        <span class="stat-label">${item.symbol}</span>
                        <span class="stat-value">
                            Avg $${item.average_close.toFixed(2)},
                            Range ${item.range_percent.toFixed(2)}%
                        </span>
                    </div>
                `).join('');

                compareContent.innerHTML = html || '<p>No data</p>';
                compareResults.classList.add('show');
            } catch (err) {
                errorBox.textContent = err.message || 'Something went wrong';
                errorBox.classList.add('show');
            } finally {
                compareButton.disabled = false;
                compareButton.textContent = 'Compare';
            }
        });
    </script>
</body>
</html>


